<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BA Tools : Markdown Editor & Viewer</title>
  <style>
    :root {
      --bg-color: #f7f7f8;
      --text-color: #1e1e1e;
      --card-bg: #fff;
      --code-bg: #f4f4f4;
      --code-text: #333;
      --primary: #2563eb;
      --primary-hover: #1e40af;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #f8f8f2;
      --card-bg: #1e1e1e;
      --code-bg: #2d2d2d;
      --code-text: #f8f8f2;
    }
    body {
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans Thai", "Noto Sans", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 60px 0 30px 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .navbar h1 { font-size: 1rem; margin: 0; }
    .navbar .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    input[type="file"] { display: none; }
    label, button, select {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    label, button.primary { background: var(--primary); color: #fff; }
    label:hover, button.primary:hover { background: var(--primary-hover); }
    button.secondary, select { background: var(--card-bg); color: var(--text-color); border: 1px solid #ccc; }
    #container {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
      display: flex;
      gap: 15px;
      width: 100%;
      height: calc(100vh - 160px);
      border: none; /* ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå */
    }
    #editor {
      width: 50%;
      height: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: none;
      font-family: "Fira Code", monospace;
      font-size: 14px;
      overflow-y: auto;
    }
    #preview {
      width: 50%;
      height: 100%;
      padding: 15px;
      border-radius: 8px;
      background: var(--card-bg);
      overflow-y: auto;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .status-bar {
      background: var(--card-bg);
      border-top: 1px solid #ccc;
      padding: 6px 12px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    .modal-content h3 { margin-top: 0; font-size: 16px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .toolbar {
      background: var(--card-bg);
      border-bottom: 1px solid #ccc;
      padding: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .toolbar button {
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: #eee;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .toolbar button:hover {
      background: #ddd;
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.0/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body data-theme="light">
  <!-- Navbar -->
  <div class="navbar">
    <h1>üìÑ BA Tools : Markdown Editor & Viewer</h1>
    <div class="actions">
      <label for="fileInput"><i class="fas fa-folder-open"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå .md</label>
      <input type="file" id="fileInput" accept=".md">
      <select id="viewMode">
        <option value="split">Split View</option>
        <option value="code">Show Code</option>
        <option value="preview">Show Preview</option>
      </select>
      <button id="themeToggle" class="secondary"><i class="fas fa-moon"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</button>
      <button onclick="toggleFullScreen()" class="secondary"><i class="fas fa-expand"></i> ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
      <button onclick="resetEditor()" class="secondary"><i class="fas fa-undo"></i> Reset</button>
      <button onclick="openReadme()" class="secondary"><i class="fas fa-book"></i> README</button>
      <button onclick="copyHTML()" class="secondary"><i class="fas fa-copy"></i> Copy HTML</button>
      <button onclick="exportPDF()" class="primary"><i class="fas fa-file-pdf"></i> Export PDF</button>
      <button onclick="saveMarkdown()" class="primary"><i class="fas fa-save"></i> Save .md</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button onclick="insertMarkdown('# ')" title="Heading 1">H1</button>
    <button onclick="insertMarkdown('## ')" title="Heading 2">H2</button>
    <button onclick="insertMarkdown('### ')" title="Heading 3">H3</button>
    <button onclick="insertMarkdown('**‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°**')" title="Bold"><b>B</b></button>
    <button onclick="insertMarkdown('*‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°*')" title="Italic"><i>I</i></button>
    <button onclick="insertMarkdown('~~‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°~~')" title="Strikethrough">S</button>
    <button onclick="insertMarkdown('- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')" title="Bullet List">‚Ä¢ List</button>
    <button onclick="insertMarkdown('1. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')" title="Numbered List">1. List</button>
    <button onclick="insertMarkdown('[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°](URL)')" title="Link">üîó</button>
    <button onclick="insertMarkdown('![alt](image.png)')" title="Image">üñºÔ∏è</button>
    <button onclick="insertMarkdown('`‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á`')" title="Inline Code">`</button>
    <button onclick="insertMarkdown('```\n‡πÇ‡∏Ñ‡πâ‡∏î\n```')" title="Code Block">{ }</button>
    <button onclick="insertMarkdown('> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°')" title="Quote">‚ùù</button>
    <button onclick="insertMarkdown('---')" title="Horizontal Line">‚îÄ‚îÄ‚îÄ</button>
    <button onclick="insertMarkdown('| ‡∏´‡∏±‡∏ß1 | ‡∏´‡∏±‡∏ß2 |\n|---|---|\n|‡∏Ñ‡πà‡∏≤1|‡∏Ñ‡πà‡∏≤2|')" title="Table">üìä</button>
    <button onclick="insertMarkdown('```mermaid\n graph TD\n A[Start] --> B{Decision?}\n B -->|Yes| C[Do]\n B -->|No| D[Skip]\n```')" title="Mermaid">üêü</button>
    <button onclick="window.open('https://www.drawdb.app/editor','_blank')">üóÑÔ∏è DrawDB</button>
    <button onclick="window.open('https://mermaid.live/edit','_blank')">üåê Mermaid Live</button>
</div>

  <!-- Container -->
  <div id="container">
    <textarea id="editor" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Markdown ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
    <div id="preview">üîé Preview ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span id="statusMode">Mode: Split View</span>
    <span id="statusLines">Lines: 0 | Words: 0 | Last Saved: -</span>
  </div>

  <!-- README Modal -->
  <div id="readmeModal" class="modal">
    <div class="modal-content">
      <h3>üìò README ‚Äì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <ul>
        <li>üìù Markdown Editor ‚Äì ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå .md</li>
        <li>üëÄ Preview ‚Äì Live ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Mermaid + Highlight.js</li>
        <li>üîÄ View Mode: Code / Preview / Split</li>
        <li>üíæ Save .md, üì§ Export PDF</li>
        <li>üåó Theme Toggle, ‚¨õ Fullscreen</li>
        <li>üóë Reset, üîÑ AutoSave</li>
        <li>üìã Copy HTML ‡∏à‡∏≤‡∏Å Preview</li>
        <li>üìÇ Drag & Drop ‡πÑ‡∏ü‡∏•‡πå .md ‡∏•‡∏á Editor ‡πÑ‡∏î‡πâ</li>
      </ul>
      <div class="modal-actions">
        <button onclick="closeReadme()" class="primary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

<script>
  mermaid.initialize({ startOnLoad: false, theme: "default" });
  hljs.configure({ ignoreUnescapedHTML: true });

  function insertMarkdown(text) {
    const editor = document.getElementById("editor");
    editor.setRangeText(text, editor.selectionStart, editor.selectionEnd, "end");
    editor.focus();
    renderPreview();
    autoSave();
  }

  function renderPreview() {
    const text = document.getElementById("editor").value;
    const dirty = marked.parse(text, { gfm: true, breaks: true });
    const clean = DOMPurify.sanitize(dirty);
    const preview = document.getElementById("preview");
    preview.innerHTML = clean;
    preview.querySelectorAll("pre code").forEach((block) => hljs.highlightElement(block));
    mermaid.run({ querySelector: "code.language-mermaid, .mermaid" });
    updateStatus();
  }

  function autoSave() {
    localStorage.setItem("markdownContent", document.getElementById("editor").value);
    updateStatus();
  }

  function updateStatus(mode = document.getElementById("viewMode").value) {
    const editor = document.getElementById("editor");
    const lines = editor.value.split("\n").length;
    const words = editor.value.trim().split(/\s+/).filter(Boolean).length;
    document.getElementById("statusMode").textContent =
      "Mode: " + (mode === "code" ? "Code Only" : mode === "preview" ? "Preview Only" : "Split View");
    document.getElementById("statusLines").textContent =
      `Lines: ${lines} | Words: ${words} | Last Saved: ${new Date().toLocaleTimeString()}`;
  }

  async function ensurePreviewSettled() {
    try { await mermaid.run({ querySelector: "code.language-mermaid, .mermaid" }); } catch (e) {}
    await new Promise(r => requestAnimationFrame(r));
    await new Promise(r => setTimeout(r, 30));
  }

  // ‚úÖ Export PDF (Advanced slicing)
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    await ensurePreviewSettled();

    const pdf = new jsPDF("p", "mm", "a4");
    const marginMM = 10, gapMM = 2;
    const pageWmm = pdf.internal.pageSize.getWidth();
    const pageHmm = pdf.internal.pageSize.getHeight();
    const usableWmm = pageWmm - marginMM * 2;
    const usableHmm = pageHmm - marginMM * 2;

    const preview = document.getElementById("preview");
    const blocks = Array.from(preview.children);
    const bg = getComputedStyle(document.body).getPropertyValue("--card-bg")?.trim() || "#ffffff";

    let yMM = marginMM;

    for (const block of blocks) {
      if (!block.innerText.trim() && !block.querySelector("img,svg,canvas")) continue;

      const canvas = await html2canvas(block, { scale: 2, useCORS: true, backgroundColor: bg });
      const pxPerMM = canvas.width / usableWmm;
      const blockHmm = canvas.height / pxPerMM;

      if (blockHmm <= (marginMM + usableHmm - yMM)) {
        pdf.addImage(canvas.toDataURL("image/png"), "PNG", marginMM, yMM, usableWmm, blockHmm, undefined, "FAST");
        yMM += blockHmm + gapMM;
        continue;
      }

      let offsetPx = 0;
      const totalPx = canvas.height;
      while (offsetPx < totalPx) {
        let remainHmm = marginMM + usableHmm - yMM;
        if (remainHmm < 1) {
          pdf.addPage(); yMM = marginMM; remainHmm = usableHmm;
        }
        let slicePx = Math.min(totalPx - offsetPx, Math.floor(remainHmm * pxPerMM));
        if (slicePx < 4) slicePx = Math.min(4, totalPx - offsetPx);

        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = slicePx;
        const sctx = sliceCanvas.getContext("2d");
        sctx.fillStyle = bg;
        sctx.fillRect(0, 0, sliceCanvas.width, sliceCanvas.height);
        sctx.drawImage(canvas, 0, offsetPx, canvas.width, slicePx, 0, 0, canvas.width, slicePx);

        const sliceHmm = slicePx / pxPerMM;
        pdf.addImage(sliceCanvas.toDataURL("image/png"), "PNG", marginMM, yMM, usableWmm, sliceHmm, undefined, "FAST");
        yMM += sliceHmm + gapMM;
        offsetPx += slicePx;

        if (yMM > marginMM + usableHmm - 1) { pdf.addPage(); yMM = marginMM; }
      }
    }
    pdf.save("markdown.pdf");
  }

  // ‚úÖ Copy HTML
  function copyHTML() {
    const html = document.getElementById("preview").innerHTML;
    navigator.clipboard.writeText(html)
      .then(() => alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å HTML ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"))
      .catch(() => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‚ùå"));
  }

  // ‚úÖ Drag & Drop
  const container = document.getElementById("container");
  container.addEventListener("dragover", (e) => {
    e.preventDefault();
    container.style.border = "2px dashed var(--primary)";
  });
  container.addEventListener("dragleave", () => {
    container.style.border = "none";
  });
  container.addEventListener("drop", async (e) => {
    e.preventDefault();
    container.style.border = "none";
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith(".md")) {
      const text = await file.text();
      document.getElementById("editor").value = text;
      renderPreview();
      autoSave();
    } else {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .md ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    }
  });

  // Scroll Sync
  const editorEl = document.getElementById("editor"), previewEl = document.getElementById("preview");
  let isSyncingEditor = false, isSyncingPreview = false;
  editorEl.addEventListener("scroll", () => {
    if (!isSyncingEditor) {
      isSyncingPreview = true;
      const ratio = editorEl.scrollTop / (editorEl.scrollHeight - editorEl.clientHeight);
      previewEl.scrollTop = ratio * (previewEl.scrollHeight - previewEl.clientHeight);
    } isSyncingEditor = false;
  });
  previewEl.addEventListener("scroll", () => {
    if (!isSyncingPreview) {
      isSyncingEditor = true;
      const ratio = previewEl.scrollTop / (previewEl.scrollHeight - previewEl.clientHeight);
      editorEl.scrollTop = ratio * (editorEl.scrollHeight - editorEl.clientHeight);
    } isSyncingPreview = false;
  });

  function toggleFullScreen() {
    const content = document.getElementById("container");
    if (!document.fullscreenElement) content.requestFullscreen();
    else document.exitFullscreen();
  }
  function resetEditor() {
    if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
      document.getElementById("editor").value = "";
      document.getElementById("preview").innerHTML = "üîé Preview ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...";
      localStorage.removeItem("markdownContent");
      updateStatus();
    }
  }
  function saveMarkdown() {
    const text = document.getElementById("editor").value;
    const fileName = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå:", "untitled");
    if (fileName) {
      const blob = new Blob([text], { type: "text/markdown" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName + ".md";
      link.click();
    }
  }
  function openReadme() { document.getElementById("readmeModal").style.display = "flex"; }
  function closeReadme() { document.getElementById("readmeModal").style.display = "none"; }
  document.getElementById("themeToggle").addEventListener("click", () => {
    const body = document.body;
    const theme = body.getAttribute("data-theme") === "dark" ? "light" : "dark";
    body.setAttribute("data-theme", theme);
    document.getElementById("themeToggle").innerHTML =
      theme === "dark" ? '<i class="fas fa-sun"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á' : '<i class="fas fa-moon"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î';
    mermaid.initialize({ startOnLoad: false, theme: theme === "dark" ? "dark" : "default" });
    renderPreview();
  });
  function setViewMode(mode) {
    const editor = document.getElementById("editor"), preview = document.getElementById("preview");
    if (mode === "code") { editor.style.display = "block"; editor.style.width = "100%"; preview.style.display = "none"; }
    else if (mode === "preview") { editor.style.display = "none"; preview.style.display = "block"; preview.style.width = "100%"; }
    else { editor.style.display = "block"; preview.style.display = "block"; editor.style.width = "50%"; preview.style.width = "50%"; }
    updateStatus(mode);
  }
  document.getElementById("viewMode").addEventListener("change", (e) => setViewMode(e.target.value));
  document.getElementById("fileInput").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (file && file.name.endsWith(".md")) {
      const text = await file.text();
      document.getElementById("editor").value = text;
      renderPreview(); autoSave();
    }
  });
  function loadAutoSave() {
    const saved = localStorage.getItem("markdownContent");
    if (saved) { document.getElementById("editor").value = saved; renderPreview(); }
  }
  document.getElementById("editor").addEventListener("input", () => { renderPreview(); autoSave(); });
  loadAutoSave(); renderPreview(); updateStatus();
</script>
</body>
</html>
